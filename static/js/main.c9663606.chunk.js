(this.webpackJsonpleibnitz=this.webpackJsonpleibnitz||[]).push([[0],{105:function(e,t,r){"use strict";r.r(t);var n,o,i=r(2),a=r(0),s=r.n(a),c=r(27),u=r.n(c),d=(r(89),r(12)),l=r(13),f=r(17),h=r(15),p=r(115),v=r(128),w=r(118),y=r(121),m=r(80),x=r(81),b=r(60),j=r(122),g=r(127),C=(r(90),r(8)),O=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(e){var n;return Object(d.a)(this,r),(n=t.call(this,e)).onResizeWindow=function(){var e=n.state.engine;null===e||void 0===e||e.resize()},n.state={},n}return Object(l.a)(r,[{key:"componentDidMount",value:function(){window.addEventListener("resize",this.onResizeWindow)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize",this.onResizeWindow)}},{key:"onCanvasLoaded",value:function(e){var t=this.props.onSceneMount,r=this.state.engine;if(e&&!r){var n=new C.Engine(e,!0,{deterministicLockstep:!0,lockstepMaxSteps:4}),o=new C.Scene(n);t&&t({scene:o,engine:n,canvas:e}),this.setState({engine:n,scene:o,canvas:e})}}},{key:"render",value:function(){var e=this;return Object(i.jsx)("canvas",{className:this.props.canvasClass,ref:function(t){return e.onCanvasLoaded(t)}})}}]),r}(a.Component),k=r(124),S=r(126),E=r(113),M=r(79),T=r(31),I=r(32),P=function(e){var t=e.name,r=e.expr,n=e.errors,o=void 0===n?[]:n,a=e.withoutDelete,s=void 0!==a&&a,c=e.onDelete,u=e.onChange,d=o.length>0,l=o.map((function(e,t){return Object(i.jsx)("li",{children:e},t)})),f=s?"":Object(i.jsx)(E.a.Append,{children:Object(i.jsx)(M.a,{variant:"danger",onClick:function(){c&&c()},children:Object(i.jsx)(T.a,{icon:I.b})})});return Object(i.jsx)(y.a.Group,{children:Object(i.jsxs)(E.a,{size:"sm",children:[Object(i.jsx)(E.a.Prepend,{children:t}),Object(i.jsx)(y.a.Control,{type:"text",value:r,onChange:function(e){u&&u(e.target.value)},isValid:!d,isInvalid:!!d}),f,Object(i.jsx)(y.a.Control.Feedback,{type:"invalid",children:Object(i.jsx)("ul",{children:l})})]})})},A=r(1),V=r.n(A),R=r(120),_=function(e){var t=e.show,r=e.title,n=e.message,o=e.confirmButton,a=e.onCancel,s=e.onConfirm;return Object(i.jsxs)(R.a,{show:t,size:"sm",onHide:function(){a&&a()},children:[Object(i.jsx)(R.a.Header,{closeButton:!0,children:Object(i.jsx)(R.a.Title,{children:r})}),Object(i.jsx)(R.a.Body,{children:n}),Object(i.jsxs)(R.a.Footer,{children:[Object(i.jsx)(M.a,{variant:"primary",onClick:function(){a&&a()},children:"Cancel"}),Object(i.jsx)(M.a,{variant:"danger",onClick:function(){s&&s()},children:o})]})]})},D=r(123),N=r(97),z=/[a-zA-Z_][a-zA-Z0-9_]*/,Q=/\d+\.?\d*/,B=/\d+\.?\d*[eE][+-]?\d+/,L=/^[a-zA-Z_][a-zA-Z0-9_]*$/,q=/^e(\d+)$/,F=/^I(\d+)$/,K=["sin","cos","tan","asin","acos","atan","sinh","cosh","tanh","exp","log","sqrt","T","qrot","tr","n","cyl","sphere","cyl1","sphere1","inv","det","min","max","PI","e","i","j","k","dt","ex","ey","ez"];function J(e){var t=q.exec(e);return t&&t.length>=2?t[1]:void 0}function Z(e){var t=F.exec(e);return t&&t.length>=2?t[1]:void 0}function H(e){if(void 0===e)throw new Error("text undefined");var t=new N;t.addRule(B,(function(e){return{type:n.Number,text:e}})).addRule(Q,(function(e){return{type:n.Number,text:e}})).addRule(z,(function(e){return{type:n.Id,text:e}})).addRule(/\s/,(function(){})).addRule(/./,(function(e){return{type:n.Symbol,text:e}}));var r=[];for(t.input=e;;){var o=t.lex();if(!o)break;r.push(o)}return r}function W(e){return e.type===n.Id}!function(e){e.Number="number",e.Id="identifier",e.Symbol="symbol"}(n||(n={})),function(e){e.Id="id",e.Number="number",e.Sym="sym",e.End="end",e.Rule="rule"}(o||(o={}));var G={node:{type:o.End},children:[]};function U(e){return{node:{type:o.Id,id:e},children:[]}}function $(e){return{node:{type:o.Number,value:e},children:[]}}function Y(e,t){return{node:{type:o.Rule,rule:e},children:t}}function X(e,t){return{node:{type:o.Rule,rule:e},children:t}}var ee=Y("expression",[Y("expr",[Y("sum",[Y("factor",[Y("unary",[X("unary-op*",[]),Y("pow",[$("0"),X("pow-suffix*",[])])]),X("factor-suffix*",[])]),X("sum-suffix*",[])]),X("expr-suffix*",[])]),G]),te=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3?arguments[3]:void 0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];Object(d.a)(this,e),this._tokens=void 0,this._current=void 0,this._errors=void 0,this._node=void 0,this._rules=void 0,this._rules=t,this._tokens=r,this._current=n,this._errors=i,this._node=o}return Object(l.a)(e,[{key:"rule",value:function(e){return this.rules[e]}},{key:"token",value:function(){var e=this.tokens,t=this.current;return t<e.length?e[t]:void 0}},{key:"next",value:function(){var t=this.tokens,r=this.current;return r<t.length?new e(this.rules,t,r+1,this.node,this.errors):this}},{key:"withNode",value:function(t){return new e(this.rules,this.tokens,this.current,t,this.errors)}},{key:"withErrors",value:function(t){return new e(this.rules,this.tokens,this.current,this.node,t)}},{key:"addError",value:function(e){var t,r=(null===(t=this.token())||void 0===t?void 0:t.text)||"<EOT>";return this.withErrors(V.a.concat(this.errors,"".concat(e,", found ").concat(r)))}},{key:"tokens",get:function(){return this._tokens}},{key:"current",get:function(){return this._current}},{key:"errors",get:function(){return this._errors}},{key:"node",get:function(){return this._node}},{key:"rules",get:function(){return this._rules}}]),e}();function re(e){return function(t){var r=t.token();if(!r||!W(r)||r.text!==e)return t.addError("".concat(e," expected"));var n=U(r.text);return t.next().withNode(n)}}function ne(e){return function(t){var r=t.token();if(!r||!function(e){return e.type===n.Symbol}(r)||r.text!==e)return t.addError("".concat(e," expected"));var i=function(e){return{node:{type:o.Sym,symbol:e},children:[]}}(e);return t.next().withNode(i)}}function oe(e){return function(t){var r=t.rule(e);return r?r(t):t.addError("Rule <".concat(e,"> not found"))}}function ie(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return function(t){for(var n=[],o=t,i=0;i<r.length;i++){var a=r[i](o);if(a.errors.length>o.errors.length)return a.addError("<".concat(e,"> expected"));a.node&&n.push(a.node),o=a}var s=Y(e,n);return o.withNode(s)}}function ae(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return function(t){for(var n=0;n<r.length;n++){var o=r[n](t);if(o.errors.length===t.errors.length)return o}return t.addError("<".concat(e,"> expected"))}}function se(e,t){return function(r){for(var n=[],o=r;;){var i=t(o);if(i.errors.length!==o.errors.length)break;i.node&&n.push(i.node),o=i}var a=X(e,n);return o.withNode(a)}}var ce={expression:ie("expression",oe("expr"),(function(e){return e.token()?e.addError("<EOF> expected"):e.withNode(G)})),expr:ie("expr",oe("sum"),oe("expr-suffix*")),"expr-suffix*":se("expr-suffix*",ie("expr-suffix",ae("expr-op",ne(",")),oe("sum"))),sum:ie("sum",oe("factor"),oe("sum-suffix*")),"sum-suffix*":se("sum-suffix*",ie("sum-suffix",ae("sum-op",ne("+"),ne("-")),oe("factor"))),factor:ie("factor",oe("unary"),oe("factor-suffix*")),"factor-suffix*":se("factor-suffix*",ie("factor-suffix",ae("factor-op",ne("*"),ne("/")),oe("unary"))),unary:ie("unary",se("unary-op*",ae("unary-op",ne("+"),ne("-"),re("sin"),re("cos"),re("tan"),re("asin"),re("acos"),re("atan"),re("sinh"),re("cosh"),re("tanh"),re("exp"),re("log"),re("sqrt"),re("T"),re("qrot"),re("tr"),re("n"),re("cyl"),re("sphere"),re("cyl1"),re("sphere1"),re("inv"),re("det"),re("min"),re("max"))),oe("pow")),pow:ie("pow",oe("terminal"),oe("pow-suffix*")),"pow-suffix*":se("pow-suffix*",ie("pow-suffix",ne("^"),oe("terminal"))),terminal:ae("terminal",(function(e){var t=e.token();if(!t)return e.addError("<number> expected");if(!function(e){return e.type===n.Number}(t))return e.addError("<number> expected");var r=$(t.text);return e.next().withNode(r)}),(function(e){var t=e.token();if(!t)return e.addError("<id> expected");if(!W(t))return e.addError("<id> expected");var r=U(t.text);return e.next().withNode(r)}),oe("bracket"),oe("module")),bracket:ie("bracket",ne("("),oe("expr"),ne(")")),module:ie("module",ne("|"),oe("expr"),ne("|"))};function ue(e){var t=ce.expression(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ce,r=H(e);return new te(t,r)}(e));return{ast:t.errors.length>0||void 0===t.node?ee:t.node,errors:t.errors}}var de=Object(D.a)("http://www.mmarini.org",D.a.URL),le=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(e){var n;return Object(d.a)(this,r),(n=t.call(this,e)).state={deleteModalShown:!1,newName:""},n}return Object(l.a)(r,[{key:"onChange",value:function(e,t){var r=this.props,n=r.onChange,o=r.panelKey,i=r.defs;if(n&&i){var a=V.a.clone(i);a[e]=t,n(o,a)}}},{key:"onDelete",value:function(e){var t=this;this.showOptionPanel('Remove "'+e+'" definition ?','The definition "'+e+'" will be removed from the list.',(function(){return t.deleteDefs(e)}))}},{key:"showOptionPanel",value:function(e,t,r){this.setState({deleteModalShown:!0,modalTitle:e,modalMessage:t,optionAction:r})}},{key:"deleteDefs",value:function(e){var t=this.props,r=t.onChange,n=t.panelKey,o=t.defs;r&&o&&r(n,V.a.omit(o,e));this.hideOptionPanel()}},{key:"hideOptionPanel",value:function(){this.setState({deleteModalShown:!1})}},{key:"onAdd",value:function(){var e=this.props,t=e.onChange,r=e.panelKey,n=e.defs;if(t&&n){var o=this.state.newName,i=V.a.clone(n);i[o]="0",t(r,i),this.setState({newName:""})}}},{key:"onName",value:function(e){this.setState({newName:e})}},{key:"newNameError",value:function(e){var t=this.props.defs;if(""===e)return"Identifier is required";var r=function(e){return e.match(L)?K.indexOf(e)>=0?'Name "'+e+'" must not be a keyword':void 0!==J(e)?'Name "'+e+'" must not be a vector base keyword':void 0!==Z(e)?'Name "'+e+'" must not be a kroneker keyword':void 0:'Name "'+e+'" must be an identifier'}(e);return r||(t&&void 0!==t[e]?"Definition already exists":"")}},{key:"render",value:function(){var e=this,t=this.props,r=t.title,n=t.defs,o=t.errors,a=this.state,s=a.deleteModalShown,c=a.modalTitle,u=a.modalMessage,d=a.optionAction,l=a.newName,f=this.newNameError(l),h=V()(n).toPairs().sortBy((function(e){return e[0]})).map((function(e){var t=e[0],r=e[1];return{id:Object(D.a)(t,de),key:t,value:r}})).value(),p=""!==f;return Object(i.jsx)(k.a,{defaultActiveKey:"0",children:Object(i.jsxs)(S.a,{children:[Object(i.jsx)(k.a.Toggle,{as:S.a.Header,eventKey:"0",children:r}),Object(i.jsx)(k.a.Collapse,{eventKey:"0",children:Object(i.jsxs)(S.a.Body,{children:[Object(i.jsx)(y.a.Group,{controlId:"validationAdd",children:Object(i.jsxs)(E.a,{size:"sm",children:[Object(i.jsx)(E.a.Prepend,{children:"Name"}),Object(i.jsx)(y.a.Control,{type:"text",value:l,onChange:function(t){return e.onName(t.target.value)},isValid:!p,isInvalid:!!p}),Object(i.jsx)(E.a.Append,{children:Object(i.jsxs)(M.a,{variant:"primary",onClick:function(){return e.onAdd()},disabled:p,children:[Object(i.jsx)(T.a,{icon:I.a}),Object(i.jsx)("span",{children:"Add definition"})]})}),Object(i.jsx)(y.a.Control.Feedback,{type:"invalid",children:f})]})}),Object(i.jsx)("hr",{}),h.map((function(t){var r=t.id,n=t.key,a=t.value;return Object(i.jsx)(P,{name:n,expr:a,errors:o?o[n]:void 0,onChange:function(t){return e.onChange(n,t)},onDelete:function(){return e.onDelete(n)}},r)})),Object(i.jsx)(_,{show:s,title:c,message:u,confirmButton:"Remove",onCancel:function(){return e.hideOptionPanel()},onConfirm:function(){d&&d()}})]})})]})})}}]),r}(a.Component),fe=r(114),he=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(e){var n;return Object(d.a)(this,r),(n=t.call(this,e)).state={modalShown:!1},n}return Object(l.a)(r,[{key:"onAddRotation",value:function(){var e=this.props,t=e.onChange,r=e.body;t&&r&&t({position:r.position,rotation:"1+0*i"})}},{key:"showOptionPanel",value:function(){this.setState({modalShown:!0})}},{key:"hideOptionPanel",value:function(){this.setState({modalShown:!1})}},{key:"deleteRotation",value:function(){var e=this.props,t=e.onChange,r=e.body;t&&r&&t({position:r.position}),this.hideOptionPanel()}},{key:"onDeleteRow",value:function(){var e=this.props.onDelete;e&&e()}},{key:"onChangePosition",value:function(e){var t=this.props,r=t.onChange,n=t.body;r&&n&&r({position:e,rotation:n.rotation})}},{key:"onChangeRotation",value:function(e){var t=this.props,r=t.onChange,n=t.body;r&&n&&r({position:n.position,rotation:e})}},{key:"render",value:function(){var e=this,t=this.props,r=t.body,n=t.errors,o=(null===r||void 0===r?void 0:r.rotation)?Object(i.jsxs)("div",{children:[Object(i.jsx)(P,{name:"",expr:r.rotation,errors:null===n||void 0===n?void 0:n.rotation,onChange:function(t){return e.onChangeRotation(t)},onDelete:function(){return e.showOptionPanel()}}),Object(i.jsx)(_,{show:this.state.modalShown,title:"Remove rotation ?",message:"The rotation will be removed from body",confirmButton:"Remove",onConfirm:function(){return e.deleteRotation()},onCancel:function(){return e.hideOptionPanel()}})]}):Object(i.jsx)(M.a,{size:"sm",variant:"primary",onClick:function(){return e.onAddRotation()},children:Object(i.jsx)(T.a,{icon:I.a})});return Object(i.jsxs)("tr",{children:[Object(i.jsx)("td",{children:this.props.id+1}),Object(i.jsx)("td",{children:Object(i.jsx)(P,{name:"",expr:null===r||void 0===r?void 0:r.position,errors:null===n||void 0===n?void 0:n.position,onChange:function(t){return e.onChangePosition(t)},withoutDelete:!0})}),Object(i.jsx)("td",{children:o}),Object(i.jsx)("td",{children:Object(i.jsx)(M.a,{size:"sm",variant:"danger",onClick:function(){return e.onDeleteRow()},children:Object(i.jsx)(T.a,{icon:I.b})})})]})}}]),r}(a.Component),pe=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(e){var n;return Object(d.a)(this,r),(n=t.call(this,e)).state={modalShown:!1},n}return Object(l.a)(r,[{key:"showOptionPanel",value:function(e,t,r){this.setState({modalShown:!0,modalTitle:e,modalMessage:t,confirmAction:r})}},{key:"hideOptionPanel",value:function(){this.setState({modalShown:!1})}},{key:"onAdd",value:function(){var e=this.props.onChange;if(e){var t=this.createBodies();t.push({position:"(0,0,0)"}),e(t)}}},{key:"onDelete",value:function(e){var t=this;this.showOptionPanel("Remove body #"+(e+1),"Body #"+(e+1)+" will be removed from the list.",(function(){return t.deleteBody(e)}))}},{key:"deleteBody",value:function(e){var t=this.props.onChange;if(t){var r=this.createBodies();r.splice(e,1),t(r)}this.hideOptionPanel()}},{key:"createBodies",value:function(){return V.a.map(this.props.bodies,(function(e){return{position:e.position,rotation:e.rotation}}))}},{key:"onChange",value:function(e,t){var r=this.props.onChange;if(r){var n=this.createBodies();n[e]=t,r(n)}}},{key:"render",value:function(){var e=this,t=this.props,r=t.bodies,n=t.errors,o=this.state,a=o.modalShown,s=o.modalTitle,c=o.modalMessage,u=o.confirmAction,d=r?V.a.map(r,(function(t,r){return Object(i.jsx)(he,{id:r,body:t,errors:n?n[r]:void 0,onChange:function(t){return e.onChange(r,t)},onDelete:function(){return e.onDelete(r)}},r)})):[];return Object(i.jsx)(k.a,{defaultActiveKey:"0",children:Object(i.jsxs)(S.a,{children:[Object(i.jsx)(k.a.Toggle,{as:S.a.Header,eventKey:"0",children:"Bodies"}),Object(i.jsx)(k.a.Collapse,{eventKey:"0",children:Object(i.jsxs)(S.a.Body,{children:[Object(i.jsxs)(M.a,{size:"sm",variant:"primary",onClick:function(){return e.onAdd()},children:[Object(i.jsx)(T.a,{icon:I.a}),"Add new body"]}),Object(i.jsx)("hr",{}),Object(i.jsx)(fe.a,{striped:!0,size:"sm",children:Object(i.jsxs)("thead",{children:[Object(i.jsxs)("tr",{children:[Object(i.jsx)("th",{scope:"col",children:"#"}),Object(i.jsx)("th",{scope:"col",children:"Position"}),Object(i.jsx)("th",{scope:"col",children:"Rotation"}),Object(i.jsx)("th",{scope:"col",children:"Remove"})]}),d]})}),Object(i.jsx)(_,{show:a,title:s,message:c,confirmButton:"Remove",onConfirm:function(){u&&u()},onCancel:function(){return e.hideOptionPanel()}})]})})]})})}}]),r}(a.Component),ve=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){return Object(d.a)(this,r),t.apply(this,arguments)}return Object(l.a)(r,[{key:"onChange",value:function(e,t){var r=this.props,n=r.onChange,o=r.defs;if(n&&o){var i=V.a.clone(o);i[e]=t,n(i)}}},{key:"onBodiesChange",value:function(e){var t=this.props,r=t.onChange,n=t.defs;if(r&&n){var o=V.a.clone(n);o.bodies=e,r(o)}}},{key:"render",value:function(){var e=this,t=this.props,r=t.defs,n=t.errors;return Object(i.jsxs)(y.a,{noValidate:!0,children:[Object(i.jsx)(pe,{bodies:null===r||void 0===r?void 0:r.bodies,errors:null===n||void 0===n?void 0:n.bodies,onChange:function(t){return e.onBodiesChange(t)}}),Object(i.jsx)(le,{panelKey:"funcs",title:"Functions",defs:null===r||void 0===r?void 0:r.funcs,errors:null===n||void 0===n?void 0:n.funcs,onChange:function(t,r){return e.onChange(t,r)}}),Object(i.jsx)(le,{panelKey:"initialStatus",title:"Initial Status",defs:null===r||void 0===r?void 0:r.initialStatus,errors:null===n||void 0===n?void 0:n.initialStatus,onChange:function(t,r){return e.onChange(t,r)}}),Object(i.jsx)(le,{panelKey:"transition",title:"Transition",defs:null===r||void 0===r?void 0:r.transition,errors:null===n||void 0===n?void 0:n.transition,onChange:function(t,r){return e.onChange(t,r)}})]})}}]),r}(a.Component),we=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(){return Object(d.a)(this,r),t.apply(this,arguments)}return Object(l.a)(r,[{key:"onFileChange",value:function(e){var t=this.props,r=t.onFileRead,n=t.onError;if(r){var o=new FileReader;o.onload=function(e){r(o.result)},o.onerror=function(e){console.error(e),n&&n(e.toString())};try{o.readAsText(e)}catch(i){console.error(i),n&&n(i.toString())}}}},{key:"render",value:function(){var e=this,t=this.props,r=t.show,n=t.onCancel;return Object(i.jsxs)(R.a,{size:"lg",show:r,onHide:function(){n&&n()},children:[Object(i.jsx)(R.a.Header,{closeButton:!0,children:Object(i.jsx)(R.a.Title,{children:"Import definitions from file ?"})}),Object(i.jsxs)(R.a.Body,{children:[Object(i.jsx)("p",{children:"The definitions will be imported from the selected file."}),Object(i.jsx)(y.a,{children:Object(i.jsx)(y.a.File,{label:"Import file",custom:!0,onChange:function(t){return e.onFileChange(t.target.files[0])}})})]}),Object(i.jsx)(R.a.Footer,{children:Object(i.jsx)(M.a,{variant:"primary",onClick:function(){n&&n()},children:"Cancel"})})]})}}]),r}(a.Component),ye=r(116);function me(e,t){if(!e)throw new Error(t?t():"Assert failed")}var xe=function(){function e(t){Object(d.a)(this,e),this._values=void 0,this._values=t}return Object(l.a)(e,[{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._values[e][t]}},{key:"toString",value:function(){var e=this,t=V.a.range(0,this.rows).map((function(t){return V.a.range(0,e.cols).map((function(r){return e.get(t,r)})).join(",")})).map((function(e){return"[".concat(e,"]")})).join(",");return"[".concat(t,"]")}},{key:"map",value:function(t){var r=this;return new e(V.a.range(0,this.rows).map((function(e){return V.a.range(0,r.cols).map((function(n){return t(r.get(e,n),e,n)}))})))}},{key:"trace",value:function(){for(var e=Math.min(this.rows,this.cols),t=0,r=0;r<e;r++)t+=this.get(r,r);return t}},{key:"negate",value:function(){return this.map((function(e){return-e}))}},{key:"zipMap",value:function(t,r){var n=this;return me(this.rows===t.rows&&this.cols===t.cols,(function(){return"Assert failed: (this.rows === other.rows && this.cols === other.cols), this=".concat(n.rows,"x").concat(n.cols,", other=").concat(t.rows,"x").concat(t.cols)})),new e(V.a.range(0,this.rows).map((function(e){return V.a.range(0,n.cols).map((function(o){return r(n.get(e,o),t.get(e,o),e,o)}))})))}},{key:"add",value:function(e){return this.zipMap(e,V.a.add)}},{key:"subtract",value:function(e){return this.zipMap(e,V.a.subtract)}},{key:"scale",value:function(e){return this.map((function(t){return t*e}))}},{key:"divide",value:function(e){return this.map((function(t){return t/e}))}},{key:"resize",value:function(t,r){var n=this.rows,o=this.cols,i=V()(this._values).take(Math.min(n,t)).map((function(e){for(var t=V.a.take(e,Math.min(o,r)),n=0;n<r-o;n++)t.push(0);return t})).value(),a=t>n?V.a.map(V.a.range(t-n),(function(){return V.a.map(V.a.range(r),(function(){return 0}))})):[];return new e(V.a.concat(i,a))}},{key:"transpose",value:function(){var t=this,r=this.rows,n=this.cols;return new e(V.a.range(0,n).map((function(e){return V.a.range(0,r).map((function(r){return t.get(r,e)}))})))}},{key:"multiply",value:function(t){var r=this;me(this.cols===t.rows,(function(){return"Assert failed: (this.cols === other.rows), this.cols="+r.cols+",other.rows="+t.rows}));var n=this.rows,o=t.cols,i=this.cols;return new e(V.a.range(0,n).map((function(e){return V.a.range(0,o).map((function(n){return V.a.sum(V.a.range(0,i).map((function(o){return r.get(e,o)*t.get(o,n)})))}))})))}},{key:"dot",value:function(e){var t=this;me(1===this.cols,(function(){return"Assert failed: (this.cols === 1), this.cols=".concat(t.cols)})),me(1===e.cols,(function(){return"Assert failed: (other.cols === 1), other.cols=".concat(e.cols)})),me(this.rows===e.rows,(function(){return"Assert failed: (this.rows === other.rows), this.rows=".concat(t.rows,", other.rows=").concat(e.rows)}));var r=this.rows;return V.a.sum(V.a.range(0,r).map((function(r){return t.get(r,0)*e.get(r,0)})))}},{key:"module",value:function(){return Math.sqrt(this.dot(this))}},{key:"norma",value:function(){var e=this.module();return e>1e-38?this.divide(e):this}},{key:"append",value:function(t){var r=this;me(this.rows===t.rows,(function(){return"Assert failed: (this.rows === other.rows), this.rows="+r.rows+",other.rows="+t.rows}));var n=this.rows,o=this.cols,i=t.cols;return new e(V.a.range(0,n).map((function(e){return V.a.range(0,o+i).map((function(n){return n<o?r.get(e,n):t.get(e,n-o)}))})))}},{key:"insertAt",value:function(t,r){var n=this;me(1===this.cols,(function(){return"Assert failed: (this.cols === 1), this.cols="+n.cols})),me(t>=0&&t<=this.rows,(function(){return"Assert failed: (idx >= 0 && idx <= this.rows), idx="+t+", this.cols="+n.cols}));var o=this.rows;return new e(V.a.range(0,o+1).map((function(e){return e<t?[n.get(e)]:e===t?[r]:[n.get(e-1)]})))}},{key:"qrot",value:function(){var e=this;me(3===this.rows&&1===this.cols,(function(){return"Assert failed: (this.rows === 3 && this.cols === 1), this.rows="+e.rows+", this.cols="+e.cols}));var t=this.get(0),r=this.get(1),n=this.get(2),o=this.module();return C.Quaternion.RotationAxis(new C.Vector3(t,r,n),o)}},{key:"cyl",value:function(){var t=this;me(3===this.rows&&1===this.cols,(function(){return"Assert failed: (this.rows === 3 && this.cols === 1), this.rows="+t.rows+", this.cols="+t.cols}));var r=this.get(0),n=this.get(1),o=this.get(2);return new e([[r*Math.sin(n)],[r*Math.cos(n)],[o]])}},{key:"sphere",value:function(){var t=this;me(3===this.rows&&1===this.cols,(function(){return"Assert failed: ((this.rows === 3 && this.cols === 1), this.rows="+t.rows+",this.cols="+t.cols}));var r=this.get(0),n=this.get(1),o=this.get(2),i=r*Math.sin(n);return new e([[i*Math.cos(o)],[i*Math.sin(o)],[r*Math.cos(n)]])}},{key:"cyl1",value:function(){var t=this;me(3===this.rows&&1===this.cols,(function(){return"Assert failed: (this.rows === 3 && this.cols === 1), this.rows="+t.rows+", this.cols="+t.cols}));var r=this.get(0),n=this.get(1),o=Math.sin(n),i=Math.cos(n);return new e([[i,-r*o,0],[o,r*i,0],[0,0,1]])}},{key:"sphere1",value:function(){var t=this;me(3===this.rows&&1===this.cols,(function(){return"Assert failed: (this.rows === 3 && this.cols === 1), this.rows="+t.rows+", this.cols="+t.cols}));var r=this.get(0,0),n=this.get(1),o=this.get(2),i=Math.sin(n),a=Math.cos(n),s=Math.sin(o),c=Math.cos(o),u=i*c,d=i*s;return new e([[u,r*(a*c),-r*d],[d,r*a*c,r*u],[a,-r*i,0]])}},{key:"inverse",value:function(){var t=this.gaussJordan().enchelon,r=this.rows;return new e(V.a.map(t,(function(e){return V.a.drop(e,r)})))}},{key:"det",value:function(){var e=this.gaussJordan().det;return e}},{key:"gaussJordan",value:function(){var e=this;me(this.rows===this.cols,(function(){return"Assert failed: (this.rows === this.cols), this.rows="+e.rows+", this.cols="+e.cols}));for(var t=this.rows,r=Array(t),n=0;n<t;n++)r[n]=Array(2*t);for(n=0;n<t;n++)for(var o=0;o<t;o++)r[n][o]=this.get(n,o),r[n][o+t]=n===o?1:0;for(var i=1,a=0,s=0;a<t&&s<t;){var c=a,u=Math.abs(r[a][s]);for(n=a+1;n<t;n++){var d=Math.abs(r[n][s]);d>u&&(c=n,u=d)}if(0===u)s++;else{var l=r[c];for(r[c]=r[a],r[a]=l,i=-i,n=a+1;n<t;n++){var f=r[n][s]/r[a][s];for(r[n][s]=0,o=s+1;o<2*t;o++)r[n][o]-=r[a][o]*f}a++,s++}}for(me(a===s,(function(){return"Inverse matrix does not exist"})),a=t-1;a>=0;a--){for(n=0;n<a;n++){var h=r[n][a]/r[a][a];for(r[n][a]=0,o=a+1;o<2*t;o++)r[n][o]-=r[a][o]*h}for(o=a+1;o<2*t;o++)r[a][o]/=r[a][a];i*=r[a][a],r[a][a]=1}return{enchelon:r,det:i}}},{key:"min",value:function(){var e;return null!==(e=V.a.min(this.flatten))&&void 0!==e?e:Number.NEGATIVE_INFINITY}},{key:"max",value:function(){var e;return null!==(e=V.a.max(this.flatten))&&void 0!==e?e:Number.POSITIVE_INFINITY}},{key:"isMatrix",get:function(){return!0}},{key:"rows",get:function(){return this._values.length}},{key:"cols",get:function(){return this.rows>0?this._values[0].length:0}},{key:"flatten",get:function(){var e=this;return V.a.flatMap(V.a.range(0,this.rows),(function(t){return V.a.range(0,e.cols).map((function(r){return e.get(t,r)}))}))}}]),e}();function be(e){return"number"===typeof e}function je(e){return void 0!==e.w}function ge(e){return!!e.isMatrix}function Ce(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new xe([t]).transpose()}function Oe(e){return new xe(e)}function ke(e){if(be(e))return["".concat(e)];if(je(e))return["".concat(e.w),"".concat(e.x),"".concat(e.y),"".concat(e.z)];if(ge(e))return 1===e.cols?V.a.range(0,e.rows).map((function(t){return"".concat(e.get(t))})):V.a.flatMap(V.a.range(0,e.rows),(function(t){return V.a.range(0,e.cols).map((function(r){return"".concat(e.get(t,r))}))}));throw new Error("unexpected value type ".concat(e))}function Se(e,t){var r=e.map(t.bodies),n=V.a.keys(e[0]).sort(),o=V.a.flatMap(n,(function(t){return function(e){if(be(e))return[""];if(je(e))return[" w"," i"," j"," k"];if(ge(e))return 1===e.cols?V.a.range(0,e.rows).map((function(e){return" ".concat(e)})):V.a.flatMap(V.a.range(0,e.rows),(function(t){return V.a.range(0,e.cols).map((function(e){return" ".concat(t,",").concat(e)}))}));throw new Error("unexpected value type ".concat(e))}(e[0][t]).map((function(e){return'"'.concat(t).concat(e,'"')}))})),i=V.a.flatMap(V.a.range(0,r[0].length),(function(e){return["x ".concat(e),"y ".concat(e),"z ".concat(e),"w ".concat(e),"i ".concat(e),"j ".concat(e),"k ".concat(e)]})),a=V.a.concat(o,i).join(","),s=e.map((function(e,t){var o=V.a.flatMap(n,(function(t){return ke(e[t])})),i=V.a.flatMap(r[t],(function(e){var t=ke(e.position),r=e.rotation?ke(e.rotation):["","","",""];return V.a.concat(t,r)}));return V.a.concat(o,i).join(",")}));return V.a.concat(a,s).join("\r\n")+"\r\n"}var Ee,Me=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(e){var n;return Object(d.a)(this,r),(n=t.call(this,e)).state={counts:"10",dt:"0.1"},n}return Object(l.a)(r,[{key:"dumpData",value:function(){var e=this.props.rules;if(e){var t=this.state,r=t.dt,n=t.counts,o=Se(function(e,t,r){for(var n=e.initialStatus(),o=[n],i=1;i<r;i++)n=e.next(n,t),o.push(n);return o}(e,parseFloat(r),parseInt(n)),e),i=new Blob([o],{type:"text/plain;charset=utf-8"});Object(b.saveAs)(i,"dump.csv")}}},{key:"setCounts",value:function(e){this.setState({counts:e})}},{key:"setDt",value:function(e){this.setState({dt:e})}},{key:"render",value:function(){var e=this,t=void 0===this.props.rules;return Object(i.jsx)(p.a,{children:Object(i.jsx)(ye.a,{children:Object(i.jsxs)(y.a,{noValidate:!0,inline:!0,children:[Object(i.jsxs)(y.a.Group,{controlId:"formInlineName",children:[Object(i.jsx)(y.a.Label,{children:"Counts"})," ",Object(i.jsx)(y.a.Control,{type:"text",placeholder:"Counts",onChange:function(t){return e.setCounts(t.target.value)},value:this.state.counts})]})," ",Object(i.jsxs)(y.a.Group,{controlId:"formInlineName",children:[Object(i.jsx)(y.a.Label,{children:"dt"})," ",Object(i.jsx)(y.a.Control,{type:"text",placeholder:"dt",onChange:function(t){return e.setDt(t.target.value)},value:this.state.dt})]}),Object(i.jsx)(M.a,{variant:"primary",disabled:t,onClick:function(){return e.dumpData()},children:"Download"})]})})})}}]),r}(a.Component),Te=r(125),Ie=r(83),Pe=r(119),Ae=r(57),Ve=function(e){var t=e.onReset,r=e.onLoad,n=e.onImport,o=e.onExport;return Object(i.jsxs)(Te.a,{variant:"dark",bg:"dark",expand:"lg",children:[Object(i.jsx)(Te.a.Brand,{href:"http://www.mmarini.org",children:"www.mmarini.org"}),Object(i.jsx)(Te.a.Toggle,{"aria-controls":"navbar-nav"}),Object(i.jsx)(Te.a.Collapse,{id:"navbar-nav",children:Object(i.jsxs)(Ie.a,{className:"mr-auto",children:[Object(i.jsxs)(Ie.a.Link,{href:"/".concat(Ae.a),children:["Leibniz ",Ae.b]}),Object(i.jsxs)(Pe.a,{id:"predefined-menu",title:"Predefined",children:[Object(i.jsx)(Pe.a.Item,{onSelect:function(){t&&t()},children:"Reset"}),Object(i.jsx)(Pe.a.Item,{onSelect:function(){r&&r("sample1.json")},children:"Basic sample"}),Object(i.jsx)(Pe.a.Item,{onSelect:function(){r&&r("bodies3.json")},children:"3 Bodies"}),Object(i.jsx)(Pe.a.Item,{onSelect:function(){r&&r("solaris.json")},children:"Solaris (Earth - Sun)"}),Object(i.jsx)(Pe.a.Item,{onSelect:function(){r&&r("selene.json")},children:"Selene (Moon -Earth)"})]}),Object(i.jsx)(Ie.a.Link,{onClick:function(){n&&n()},children:"Import"}),Object(i.jsx)(Ie.a.Link,{onClick:function(){o&&o()},children:"Export"}),Object(i.jsx)(Ie.a.Link,{href:"https://github.com/m-marini/leibniz/wiki/Expression-syntax",target:"leibniz-help",children:"Help"})]})})]})},Re=r(117),_e=function(e){var t=e.isVisible,r=void 0!==t&&t,n=e.onClose,o=e.title,a=e.message;return r?Object(i.jsxs)(Re.a,{variant:"danger",dismissible:!0,onClose:function(){n&&n()},children:[Object(i.jsx)(Re.a.Heading,{children:o}),Object(i.jsx)("p",{children:a})]}):Object(i.jsx)("span",{})},De="0.1",Ne=r(29);!function(e){e.DeviceOrientation="do",e.Anaglyph="ac",e.VRDeviceOrientation="vr",e.ArcRotate="ar",e.Universal="un"}(Ee||(Ee={}));function ze(e){return function(e,t,r){var n=null;return n=e<=0?C.Color3.Red():e<1/6?new C.Color3(1,6*e,0):e<2/6?new C.Color3(2-6*e,1,0):e<.5?new C.Color3(0,1,6*e-2):e<4/6?new C.Color3(0,4-6*e,1):e<5/6?new C.Color3(6*e-4,0,1):e<1?new C.Color3(1,0,6-6*e):C.Color3.Red(),C.Color3.White().scale(1-t).add(n.scale(t)).scale(r)}(5*(1-e)/6,1,1-.2*(1-e))}var Qe,Be=function(){function e(t){Object(d.a)(this,e),this._props=void 0,this._maxDt=void 0,this._status=void 0,this._rules=void 0,this._shapes=void 0,this._remainderT=void 0,this._props=t,this._maxDt=1/60,this._shapes=[],this._remainderT=0}return Object(l.a)(e,[{key:"createShapes",value:function(e){var t=this,r=this.props.scene,n=e.length;return V.a.map(e,(function(e,o){var i="Body"+o,a=ze(n>1?o/(n-1):0),s=void 0!==e.rotation?function(e,t,r){var n=new C.StandardMaterial("Material_"+t,e);n.ambientColor=r,n.diffuseColor=r;var o=C.MeshBuilder.CreatePolyhedron("Octa_"+t,{type:1,sizeX:.1,sizeY:.2,sizeZ:.05},e);return o.material=n,o}(r,i,a):function(e,t,r){var n=new C.StandardMaterial("Material_"+t,e);n.ambientColor=r,n.diffuseColor=r;var o=C.MeshBuilder.CreateIcoSphere("Sphere_"+t,{flat:!1,radius:.1,subdivisions:4,updatable:!1},e);return o.material=n,o}(r,i,a);return t.updateShape(s,e),s}))}},{key:"init",value:function(e){var t=this,r=this.props,n=r.engine,o=r.scene,i=V.a.assign({cameraType:Ee.DeviceOrientation,cameraPosition:new C.Vector3(0,0,-10),cameraMinZ:.5,ambientColor:new C.Color3(.2,.2,.2),sunLightDirection:new C.Vector3(1,1,-1),sunLightIntensity:.7,maxDt:1/60},e||{});return this._maxDt=i.maxDt,function(e,t){switch(t.cameraType){case Ee.DeviceOrientation:var r=new C.DeviceOrientationCamera("DevOr_camera",new C.Vector3(0,0,0),e);return r.position=t.cameraPosition,r.setTarget(C.Vector3.Zero()),r.angularSensibility=10,r;case Ee.Anaglyph:var n=new C.AnaglyphArcRotateCamera("aar_cam",-Math.PI/2,Math.PI/4,20,C.Vector3.Zero(),.033,e);return n.target=C.Vector3.Zero(),n.setPosition(t.cameraPosition),n;case Ee.VRDeviceOrientation:var o=new C.VRDeviceOrientationArcRotateCamera("Camera",Math.PI/2,Math.PI/4,25,new C.Vector3(0,0,0),e);return o.target=C.Vector3.Zero(),o.setPosition(t.cameraPosition),o;case Ee.ArcRotate:var i=new C.ArcRotateCamera("ArcRotateCamera",0,0,0,new C.Vector3(0,0,0),e);return i.wheelPrecision=20,i.setPosition(t.cameraPosition),i;default:var a=new C.UniversalCamera("UniversalCamera",t.cameraPosition,e);return a.inputs.addMouseWheel(),a}}(this.props.scene,i).attachControl(this.props.canvas,!0),new C.HemisphericLight("sunLight",i.sunLightDirection,this.props.scene).intensity=i.sunLightIntensity,o.ambientColor=i.ambientColor,o.onBeforeStepObservable.add((function(e){var r=t.rules,n=t.status;if(r&&n){for(var o=e.getEngine().getDeltaTime()/1e3,i=Math.min(t.maxDt,o),a=n,s=t._remainderT;s<o;s+=i)a=r.next(a,i);t._remainderT=s-o,t._status=a}})),n.runRenderLoop((function(){t.refreshScene(),o.render()})),this}},{key:"refreshScene",value:function(){var e=this,t=this.status,r=this.shapes,n=this.rules;if(t&&n){var o=n.bodies(t);V.a.zip(o,r).forEach((function(t){var r=Object(Ne.a)(t,2),n=r[0],o=r[1];n&&o&&e.updateShape(o,n)}))}}},{key:"updateShape",value:function(e,t){e.position=new C.Vector3(t.position.get(0),t.position.get(1),t.position.get(2)),t.rotation&&(e.rotationQuaternion=t.rotation)}},{key:"refresh",value:function(){this.props.engine.resize()}},{key:"resetStatus",value:function(){var e=this.rules;e&&(this._status=e.initialStatus())}},{key:"props",get:function(){return this._props}},{key:"rules",get:function(){return this._rules},set:function(e){var t=this;if(V.a.each(this._shapes,(function(e){return t.props.scene.removeMesh(e,!0)})),e){var r=e.initialStatus(),n=e.bodies(r);this._shapes=this.createShapes(n),this._status=r}else this._status=void 0,this._shapes=[];this._rules=e}},{key:"status",get:function(){return this._status}},{key:"shapes",get:function(){return this._shapes}},{key:"maxDt",get:function(){return this._maxDt},set:function(e){this._maxDt=e}}]),e}();function Le(e){0}function qe(e){return function(t){return Le(),e}}function Fe(e){return function(t){var r=t[e];if(void 0===r)throw new Error("Reference ".concat(e," not defined"));if(!ge(r))throw new Error("Reference ".concat(e," is not a number"));return Le(),r}}function Ke(e){return function(t){var r=e(t),n=r.negate();return Le(),n}}function Je(e){return function(t){var r=e(t),n=r.transpose();return Le(),n}}function Ze(e,t){return function(r){var n=e(r),o=t(r),i=o.scale(n);return Le(),i}}function He(e,t){return function(r){var n=e(r),o=t(r),i=o.scale(n);return Le(),i}}function We(e,t){return function(r){var n=e(r),o=t(r),i=n.multiply(o);return Le(),i}}function Ge(e,t){return function(r){var n=e(r),o=t(r),i=n.divide(o);return Le(),i}}function Ue(e,t){return function(r){var n=e(r),o=t(r),i=o.add(C.Quaternion.Identity().scale(n));return Le(),i}}function $e(e,t){return function(r){var n=e(r),o=t(r),i=n.add(o);return Le(),i}}function Ye(e,t){return function(r){var n=e(r),o=t(r),i=n.subtract(o);return Le(),i}}function Xe(e,t){return function(r){var n=e(r),o=t(r),i=n.append(o);return Le(),i}}function et(e,t,r){return function(n){var o=e(n),i=o.resize(t,r);return Le(),i}}function tt(e){return e.type===Qe.Scalar}function rt(e){return e.type===Qe.Quaternion}function nt(e){return e.type===Qe.Vector}function ot(e){return e.type===Qe.Matrix}function it(e){return{type:Qe.Scalar,code:e}}function at(e){return{type:Qe.Quaternion,code:e}}function st(e,t){return{type:Qe.Vector,rows:t,code:e}}function ct(e,t,r){return{type:Qe.Matrix,rows:t,cols:r,code:e}}function ut(e){return it(qe(e))}function dt(e){return at(qe(e))}function lt(e){return st(qe(e),e.rows)}function ft(e){return ct(qe(e),e.rows,e.cols)}function ht(e){return it(function(e){return function(t){var r=t[e];if(void 0===r)throw new Error("Reference ".concat(e," not defined"));if(!be(r))throw new Error("Reference ".concat(e," is not a number"));return Le(),r}}(e))}function pt(e){return at(function(e){return function(t){var r=t[e];if(void 0===r)throw new Error("Reference ".concat(e," not defined"));if(!je(r))throw new Error("Reference ".concat(e," is not a number"));return Le(),r}}(e))}function vt(e,t){return st(Fe(e),t)}function wt(e,t,r){return ct(Fe(e),t,r)}!function(e){e.Scalar="scalar",e.Vector="vector",e.Quaternion="quaternion",e.Matrix="matrix"}(Qe||(Qe={}));var yt={PI:ut(Math.PI),e:ut(Math.E),i:dt(new C.Quaternion(1,0,0,0)),j:dt(new C.Quaternion(0,1,0,0)),k:dt(new C.Quaternion(0,0,1,0)),ex:lt(Ce(1,0,0)),ey:lt(Ce(0,1,0)),ez:lt(Ce(0,0,1))},mt=["dt"],xt=ut(0),bt=dt(C.Quaternion.Identity());function jt(e){return lt(Ce.apply(void 0,V.a.range(0,e).map((function(){return 0}))))}var gt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:xt,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];Object(d.a)(this,e),this.typeCode=void 0,this.symbols=void 0,this.errors=void 0,this.typeCode=r,this.symbols=t,this.errors=n}return Object(l.a)(e,[{key:"addErrors",value:function(t){return new e(this.symbols,this.typeCode,V.a.concat(this.errors,t))}},{key:"withTypeCode",value:function(t){return new e(this.symbols,t,this.errors)}},{key:"symbol",value:function(e){return this.symbols[e]}},{key:"addSymbol",value:function(e,t){return this}}]),e}();function Ct(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new gt(e)}var Ot={sin:Rt(Math.sin),cos:Rt(Math.cos),tan:Rt(Math.tan),asin:Rt(Math.asin),acos:Rt(Math.acos),atan:Rt(Math.atan),sinh:Rt(Math.sinh),cosh:Rt(Math.cosh),tanh:Rt(Math.tanh),exp:Rt(Math.exp),log:Rt(Math.log),sqrt:Rt(Math.sqrt),T:function(e){var t=e.typeCode;switch(t.type){case Qe.Scalar:case Qe.Quaternion:return e;case Qe.Vector:return e.withTypeCode(ct(Je(t.code),1,t.rows));case Qe.Matrix:return e.withTypeCode(ct(Je(t.code),t.cols,t.rows))}},qrot:function(e){var t=e.typeCode;if(!nt(t)||3!==t.rows)return e.addErrors(Et("vector3 expected",t));return e.withTypeCode(at((r=t.code,function(e){var t=r(e).qrot();return Le(),t})));var r},tr:function(e){var t=e.typeCode;if(!ot(t)||t.rows!==t.cols)return e.addErrors(Et("square matrix expected",t));return e.withTypeCode(it((r=t.code,function(e){var t=r(e).trace();return Le(),t})));var r},n:function(e){var t=e.typeCode;if(!nt(t))return e.addErrors(Et("vector expected",t));return e.withTypeCode(st((r=t.code,function(e){var t=r(e).norma();return Le(),t}),t.rows));var r},cyl:function(e){var t=e.typeCode;if(!nt(t)||3!==t.rows)return e.addErrors(Et("vector3 expected",t));return e.withTypeCode(st((r=t.code,function(e){var t=r(e).cyl();return Le(),t}),3));var r},cyl1:function(e){var t=e.typeCode;if(!nt(t)||3!==t.rows)return e.addErrors(Et("vector3 expected",t));return e.withTypeCode(ct((r=t.code,function(e){var t=r(e).cyl1();return Le(),t}),3,3));var r},sphere:function(e){var t=e.typeCode;if(!nt(t)||3!==t.rows)return e.addErrors(Et("vector3 expected",t));return e.withTypeCode(st((r=t.code,function(e){var t=r(e).sphere();return Le(),t}),3));var r},sphere1:function(e){var t=e.typeCode;if(!nt(t)||3!==t.rows)return e.addErrors(Et("vector3 expected",t));return e.withTypeCode(ct((r=t.code,function(e){var t=r(e).sphere1();return Le(),t}),3,3));var r},inv:function(e){var t=e.typeCode;switch(t.type){case Qe.Scalar:return e.withTypeCode(it((r=t.code,function(e){var t=1/r(e);return Le(),t})));case Qe.Quaternion:return e.withTypeCode(at(function(e){return function(t){var r=e(t),n=C.Quaternion.Inverse(r);return Le(),n}}(t.code)));case Qe.Vector:return e.addErrors(Et("not vector expected",t));case Qe.Matrix:return t.cols!==t.rows?e.addErrors(Et("square matrix expected",t)):e.withTypeCode(ct(function(e){return function(t){var r=e(t).inverse();return Le(),r}}(t.code),t.rows,t.cols));default:throw new Error("Inconsistency branch")}var r},det:function(e){var t=e.typeCode;switch(t.type){case Qe.Scalar:case Qe.Quaternion:return e;case Qe.Vector:return e.addErrors(Et("square matrix expected",t));case Qe.Matrix:return t.cols!==t.rows?e.addErrors(Et("square matrix expected",t)):e.withTypeCode(it((r=t.code,function(e){var t=r(e).det();return Le(),t})));default:throw new Error("Inconsistency branch")}var r},min:function(e){var t=e.typeCode;switch(t.type){case Qe.Scalar:case Qe.Quaternion:return e.addErrors(Et("vector or matrix expected",t));case Qe.Vector:case Qe.Matrix:return e.withTypeCode(it((r=t.code,function(e){var t=r(e).min();return Le(),t})));default:throw new Error("Inconsistency branch")}var r},max:function(e){var t=e.typeCode;switch(t.type){case Qe.Scalar:case Qe.Quaternion:return e.addErrors(Et("vector or matrix expected",t));case Qe.Vector:case Qe.Matrix:return e.withTypeCode(it((r=t.code,function(e){var t=r(e).max();return Le(),t})));default:throw new Error("Inconsistency branch")}var r}},kt=V.a.keys(Ot),St=V.a.merge({"+":function(e){return e},"-":function(e){var t=e.typeCode;if(tt(t))return e.withTypeCode(it((r=t.code,function(e){var t=-r(e);return Le(),t})));var r;if(rt(t))return e.withTypeCode(at(function(e){return function(t){var r=e(t),n=C.Quaternion.Zero().subtract(r);return Le(),n}}(t.code)));if(nt(t))return e.withTypeCode(st(Ke(t.code),t.rows));return e.withTypeCode(ct(Ke(t.code),t.rows,t.cols))}},Ot);function Et(e,t){switch(t.type){case Qe.Scalar:return["".concat(e,", scalar found")];case Qe.Quaternion:return["".concat(e,", quaternion found")];case Qe.Vector:return["".concat(e,", vector").concat(t.rows," found")];case Qe.Matrix:return["".concat(e,", matrix").concat(t.rows,"x").concat(t.cols," found")];default:return[]}}function Mt(e,t,r){var n=e.node,i=e.children;if(n.type!==o.Rule)throw Error("node ".concat(n.type," !== ").concat(o.Rule));if(n.rule!==t)throw Error("node ".concat(n.rule," !== ").concat(t));if(void 0!==r&&i.length!==r)throw Error("number of children ".concat(i.length," !== ").concat(r))}function Tt(e,t){return Mt(t,"expression",2),It(e,t.children[0])}function It(e,t){return Mt(t,"expr",2),function(e,t){if(Mt(t,"expr-suffix*"),0===t.children.length)return e;return V()(t.children).reduce((function(e,t){Mt(t,"expr-suffix",2);var r=Pt(e,t.children[1]),n=t.children[0].node;if(n.type!==o.Sym)throw new Error("unexpected node type ".concat(n.type));return function(e,t,r){if(tt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(st(function(e,t){return function(r){var n=Ce(e(r),t(r));return Le(),n}}(t.code,r.code),2));case Qe.Vector:return e.withTypeCode(st(function(e,t){return function(r){var n=e(r),o=t(r).insertAt(0,n);return Le(),o}}(t.code,r.code),r.rows+1));case Qe.Quaternion:case Qe.Matrix:return e.addErrors(Et("scalar or vector expected",r))}if(rt(t))return e.addErrors(Et("quaternion cannot be concatenated",r));if(nt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(st(function(e,t){return function(r){var n=e(r),o=t(r),i=n.insertAt(n.rows,o);return Le(),i}}(t.code,r.code),t.rows+1));case Qe.Quaternion:return e.addErrors(Et("scalar or vector expected",r));case Qe.Vector:var n=t.rows<r.rows?et(t.code,r.rows,1):t.code,o=r.rows<t.rows?et(r.code,t.rows,1):r.code;return e.withTypeCode(ct(Xe(n,o),Math.max(t.rows,r.rows),2));case Qe.Matrix:var i=t.rows<r.rows?et(t.code,r.rows,1):t.code,a=r.rows<t.rows?et(r.code,t.rows,r.cols):r.code;return e.withTypeCode(ct(Xe(i,a),Math.max(t.rows,r.rows),r.cols+1))}if(ot(t))switch(r.type){case Qe.Scalar:case Qe.Quaternion:return e.addErrors(Et("vector or matrix expected",r));case Qe.Vector:var s=t.rows<r.rows?et(t.code,r.rows,t.cols):t.code,c=r.rows<t.rows?et(r.code,t.rows,1):r.code;return e.withTypeCode(ct(Xe(s,c),Math.max(t.rows,r.rows),t.cols+1));case Qe.Matrix:var u=t.rows<r.rows?et(t.code,r.rows,t.cols):t.code,d=r.rows<t.rows?et(r.code,t.rows,r.cols):r.code;return e.withTypeCode(ct(Xe(u,d),Math.max(t.rows,r.rows),t.cols+r.cols))}throw new Error("invalid branch ".concat(r.type))}(r,e.typeCode,r.typeCode)}),e)}(Pt(e,t.children[0]),t.children[1])}function Pt(e,t){return Mt(t,"sum",2),function(e,t){if(Mt(t,"sum-suffix*"),0===t.children.length)return e;return V()(t.children).reduce((function(e,t){Mt(t,"sum-suffix",2);var r=At(e,t.children[1]),n=t.children[0].node;if(n.type!==o.Sym)throw new Error("unexpected node type ".concat(n.type));switch(n.symbol){case"+":return function(e,t,r){if(tt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(it(function(e,t){return function(r){var n=e(r)+t(r);return Le(),n}}(t.code,r.code)));case Qe.Quaternion:return e.withTypeCode(at(Ue(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(rt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(at(Ue(r.code,t.code)));case Qe.Quaternion:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=n.add(o);return Le(),i}}(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(nt(t)){if(nt(r)){var n=t.rows<r.rows?et(t.code,r.rows,1):t.code,o=r.rows<t.rows?et(r.code,t.rows,1):r.code;return e.withTypeCode(st($e(n,o),Math.max(t.rows,r.rows)))}return e.addErrors(Et("vector expected",r))}if(ot(t)){if(ot(r)){var i=Math.max(t.rows,r.rows),a=Math.max(t.cols,r.cols),s=t.rows<i||t.cols<a?et(t.code,i,a):t.code,c=r.rows<i||r.cols<a?et(r.code,i,a):r.code;return e.withTypeCode(ct($e(s,c),i,a))}return e.addErrors(Et("matrix expected",r))}throw new Error("Invalid branch")}(r,e.typeCode,r.typeCode);case"-":return function(e,t,r){if(tt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(it(function(e,t){return function(r){var n=e(r)-t(r);return Le(),n}}(t.code,r.code)));case Qe.Quaternion:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=C.Quaternion.Identity().scale(n).subtract(o);return Le(),i}}(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(rt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=n.subtract(C.Quaternion.Identity().scale(o));return Le(),i}}(t.code,r.code)));case Qe.Quaternion:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=n.subtract(o);return Le(),i}}(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(nt(t)){if(nt(r)){var n=Math.max(t.rows,r.rows),o=t.rows<n?et(t.code,n,1):t.code,i=r.rows<n?et(r.code,n,1):r.code;return e.withTypeCode(st(Ye(o,i),n))}return e.addErrors(Et("vector expected",r))}if(ot(t)){if(ot(r)){var a=Math.max(t.rows,r.rows),s=Math.max(t.cols,r.cols),c=t.rows<a||t.cols<s?et(t.code,a,s):t.code,u=r.rows<a||r.cols<s?et(r.code,a,s):r.code;return e.withTypeCode(ct(Ye(c,u),a,s))}return e.addErrors(Et("matrix expected",r))}throw new Error("Invalid branch")}(r,e.typeCode,r.typeCode);default:throw new Error("unexpected symbol ".concat(n.symbol))}}),e)}(At(e,t.children[0]),t.children[1])}function At(e,t){return Mt(t,"factor",2),function(e,t){if(Mt(t,"factor-suffix*"),0===t.children.length)return e;return V()(t.children).reduce((function(e,t){Mt(t,"factor-suffix",2);var r=Vt(e,t.children[1]),n=t.children[0].node;if(n.type!==o.Sym)throw new Error("unexpected node type ".concat(n.type));switch(n.symbol){case"*":return function(e,t,r){if(tt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(it(function(e,t){return function(r){var n=e(r)*t(r);return Le(),n}}(t.code,r.code)));case Qe.Quaternion:return e.withTypeCode(at(Ze(t.code,r.code)));case Qe.Vector:return e.withTypeCode(st(He(t.code,r.code),r.rows));case Qe.Matrix:return e.withTypeCode(ct(He(t.code,r.code),r.rows,r.cols))}if(rt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(at(Ze(r.code,t.code)));case Qe.Quaternion:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=n.multiply(o);return Le(),i}}(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(nt(t)){switch(r.type){case Qe.Scalar:return e.withTypeCode(st(He(r.code,t.code),t.rows));case Qe.Vector:var n=Math.min(t.rows,r.rows),o=t.rows>n?et(t.code,n,1):t.code,i=r.rows>n?et(r.code,n,1):r.code;return e.withTypeCode(it(function(e,t){return function(r){var n=e(r),o=t(r),i=n.dot(o);return Le(),i}}(o,i)))}return e.addErrors(Et("scalar expected",r))}if(ot(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(ct(He(r.code,t.code),t.rows,t.cols));case Qe.Vector:var a=Math.min(t.cols,r.rows),s=t.cols>a?et(t.code,t.rows,a):t.code,c=r.rows>a?et(r.code,a,1):r.code;return e.withTypeCode(st(We(s,c),t.rows));case Qe.Quaternion:return e.addErrors(Et("not quaternion expected",r));case Qe.Matrix:var u=Math.min(t.cols,r.rows),d=t.cols>u?et(t.code,t.rows,u):t.code,l=r.rows>u?et(r.code,u,r.cols):r.code;return e.withTypeCode(ct(We(d,l),t.rows,r.cols))}throw new Error("Invalid branch")}(r,e.typeCode,r.typeCode);case"/":return function(e,t,r){if(tt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(it(function(e,t){return function(r){var n=e(r)/t(r);return Le(),n}}(t.code,r.code)));case Qe.Quaternion:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=C.Quaternion.Inverse(o).scale(n);return Le(),i}}(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(rt(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=n.scale(1/o);return Le(),i}}(t.code,r.code)));case Qe.Quaternion:return e.withTypeCode(at(function(e,t){return function(r){var n=e(r),o=t(r),i=n.multiply(C.Quaternion.Inverse(o));return Le(),i}}(t.code,r.code)));case Qe.Vector:case Qe.Matrix:return e.addErrors(Et("scalar or quaternion expected",r))}if(nt(t))return tt(r)?e.withTypeCode(st(Ge(t.code,r.code),t.rows)):e.addErrors(Et("scalar expected",r));if(ot(t))switch(r.type){case Qe.Scalar:return e.withTypeCode(ct(Ge(t.code,r.code),t.rows,t.cols));case Qe.Vector:case Qe.Quaternion:return e.addErrors(Et("scalar or matrix expected",r));case Qe.Matrix:var n=Math.min(t.cols,r.rows,r.cols),o=t.cols>n?et(t.code,t.rows,n):t.code,i=r.rows>n||r.cols>n?et(r.code,n,n):r.code;return e.withTypeCode(ct(function(e,t){return function(r){var n=e(r),o=t(r),i=n.multiply(o.inverse());return Le(),i}}(o,i),t.rows,n))}throw new Error("Invalid branch")}(r,e.typeCode,r.typeCode);default:throw new Error("unexpected symbol ".concat(n.symbol))}}),e)}(Vt(e,t.children[0]),t.children[1])}function Vt(e,t){return Mt(t,"unary",2),function(e,t){if(Mt(t,"unary-op*"),0===t.children.length)return e;return V()(t.children).reduceRight((function(e,t){var r;switch(t.node.type){case o.Id:r=t.node.id;break;case o.Sym:r=t.node.symbol;break;default:throw new Error("unexpected ".concat(t.node.type))}var n=St[r];if(!n)throw new Error("".concat(r," is not an operator"));return n(e)}),e)}(function(e,t){return Mt(t,"pow",2),function(e,t){if(Mt(t,"pow-suffix*"),0===t.children.length)return e;var r=e.typeCode;if(!tt(r))return e.addErrors(Et("scalar expected",r));return V()(t.children).reduce((function(e,t){Mt(t,"pow-suffix",2);var r=e.typeCode;if(!tt(r))throw new Error("invalid branch");var n,o,i=_t(e,t.children[1]),a=i.typeCode;return tt(a)?i.withTypeCode(it((n=r.code,o=a.code,function(e){var t=n(e),r=o(e),i=Math.pow(t,r);return Le(),i}))):i.addErrors(Et("scalar expected",a))}),e)}(_t(e,t.children[0]),t.children[1])}(e,t.children[1]),t.children[0])}function Rt(e){return function(t){var r=t.typeCode;return tt(r)?t.withTypeCode(it(function(e,t){return function(r){e(r);var n=t(e(r));return Le(),n}}(r.code,e))):t.addErrors(Et("scalar expected",r))}}function _t(e,t){var r=t.node;switch(r.type){case o.Number:return e.withTypeCode(ut(parseFloat(r.value)));case o.Id:return function(e,t){if(mt.indexOf(t)>=0)return e.withTypeCode(ht(t));var r=yt[t];if(r)return e.withTypeCode(r);var n=J(t);if(n){var o=parseInt(n),i=V.a.range(0,o+1).map((function(e){return e===o?1:0}));return e.withTypeCode(lt(Ce.apply(void 0,i)))}var a=Z(t);if(a){var s=parseInt(a),c=V.a.range(0,s).map((function(e){return V.a.range(0,s).map((function(t){return e===t?1:0}))}));return e.withTypeCode(ft(Oe(c)))}var u=e.symbol(t);return e.withTypeCode(null!==u&&void 0!==u?u:xt)}(e,r.id);case o.Rule:switch(r.rule){case"bracket":return function(e,t){return Mt(t,"bracket",3),It(e,t.children[1])}(e,t);case"module":return function(e,t){Mt(t,"module",3);var r=It(e,t.children[1]),n=r.typeCode;switch(n.type){case Qe.Scalar:return r.withTypeCode(it((o=n.code,function(e){var t=o(e),r=Math.abs(t);return Le(),r})));case Qe.Quaternion:return r.withTypeCode(it(function(e){return function(t){var r=e(t).length();return Le(),r}}(n.code)));case Qe.Vector:return r.withTypeCode(it(function(e){return function(t){var r=e(t).module();return Le(),r}}(n.code)));case Qe.Matrix:return r.addErrors(Et("not matrix expected",n))}var o}(e,t)}}throw new Error("invalid tree at ".concat(r.type))}var Dt=r(82),Nt=/^(\d*)\.(\d*)$/,zt={type:"object",properties:{version:{type:"string",pattern:"^\\d*\\.\\d*$"},bodies:{type:"array",items:{type:"object",properties:{position:{type:"string"},rotation:{type:"string"}},required:["position"]}},funcs:{type:"object",additionalProperties:{type:"string"}},initialStatus:{type:"object",additionalProperties:{type:"string"}},transition:{type:"object",additionalProperties:{type:"string"}}},required:["version","bodies","funcs","initialStatus","transition"]},Qt=V.a.concat(kt,V.a.keys(yt),"dt");function Bt(e,t){return e.map((function(e){return function(e,t){return{position:t(e.position),rotation:e.rotation?t(e.rotation):void 0}}(e,t)}))}function Lt(e,t,r){return e.map((function(e){return function(e,t,r){return{position:t(e.position),rotation:e.rotation?r(e.rotation):void 0}}(e,t,r)}))}function qt(e,t){return{bodies:Bt(e.bodies,t),funcs:V.a.mapValues(e.funcs,t),initialStatus:V.a.mapValues(e.initialStatus,t),transition:V.a.mapValues(e.transition,t)}}function Ft(e){var t,r,n=(t=e,r=function(e){return e},function e(t){var n=r(t.node),o=V.a.flatMap(t.children,e);return V.a.concat(o,n)}(t)).map((function(e){switch(e.type){case o.Id:return e.id;default:return""}})).filter((function(e){return!!e}))||[];return n.filter((function(e){return!(Qt.indexOf(e)>=0||void 0!==Z(e)||void 0!==J(e))}))}function Kt(e,t){return qt(function(e,t){function r(e,t){return V()([t,e]).flatMap(V.a.keys).map((function(r){return[r,[e[r],t[r]]]})).fromPairs().value()}return{bodies:V.a.zip(e.bodies,t.bodies).map((function(e){var t=Object(Ne.a)(e,2),r=t[0],n=t[1];return{position:[null===r||void 0===r?void 0:r.position,null===n||void 0===n?void 0:n.position],rotation:void 0!==(null===r||void 0===r?void 0:r.rotation)||void 0!==(null===n||void 0===n?void 0:n.rotation)?[null===r||void 0===r?void 0:r.rotation,null===n||void 0===n?void 0:n.rotation]:void 0}})),funcs:r(e.funcs,t.funcs),initialStatus:r(e.initialStatus,t.initialStatus),transition:r(e.transition,t.transition)}}(e,t),(function(e){var t=Object(Ne.a)(e,2),r=t[0],n=t[1];return V.a.concat(r||[],n||[])}))}function Jt(e){for(var t=V()(e).toPairs().flatMap((function(e){var t=Object(Ne.a)(e,2);t[0];return t[1]})).value(),r=V.a.uniq(V.a.concat(V.a.keys(e),t)),n=r.length,o=V.a.range(0,n).map((function(){return V.a.range(0,n).map((function(){return!1}))})),i=function(){var t=a;(e[r[t]]||[]).forEach((function(e){o[t][r.indexOf(e)]=!0}))},a=0;a<n;a++)i();for(var s=0;s<n;++s)for(var c=0;c<n;++c)for(var u=0;u<n;++u)o[c][s]&&o[s][u]&&(o[c][u]=!0);return V()(V.a.range(0,n)).map((function(e){var t=V()(V.a.range(0,n)).map((function(t){return{to:r[t],value:o[e][t]}})).filter({value:!0}).map("to").value();return[r[e],t]})).fromPairs().value()}function Zt(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=V()(t).flatMap((function(e){return V.a.keys(e)})),o=n.map((function(e){var r=V()(t).flatMap((function(t){return t[e]||[]})).value();return[e,r]})).fromPairs().value();return o}function Ht(e){function t(r,n){if(n.indexOf(r)>=0)return n;var o=e[r];if(o){var i=V()(o).reduce((function(e,r){return t(r,e)}),n);return V.a.concat(i,r)}return V.a.concat(n,r)}var r=V.a.keys(e);return V.a.reduce(r,(function(e,r){return t(r,e)}),[])}function Wt(e,t){var r=V.a.mapValues(e,Ft),n=V.a.keys(r),o=Jt(r),i=V()(o).toPairs().filter((function(e){var t=Object(Ne.a)(e,2),r=t[0];return t[1].indexOf(r)>=0})).map((function(e){var t=Object(Ne.a)(e,2),r=t[0];t[1];return r})).value(),a=V.a.difference(n,i),s=Ht(V()(a).map((function(e){return[e,r[e]]})).fromPairs().value()),c=V()(i).map((function(e){return[e,ut(0)]})).fromPairs().value(),u=V.a.assign({},c,t),d=V()(i).map((function(e){return[e,['"'.concat(e,'" is a cycle reference')]]})).fromPairs().value(),l=V()(r).values().flatten().uniq().value(),f=V.a.difference(l,n,V.a.keys(t)),h=Zt(d,V()(r).mapValues((function(e,t){return e.filter((function(e){return f.indexOf(e)>=0})).map((function(e){return'"'.concat(e,'" is not defined')}))})).value());return V()(s).reduce((function(t,r){var n=t.table,o=t.errors;if(void 0!==n[r])return t;var i=e[r],a=V.a.clone(n);if(void 0!==i){var s,c=Tt(Ct(n),i);a[r]=c.typeCode;var u=V.a.clone(o);return u[r]=V.a.concat(null!==(s=u[r])&&void 0!==s?s:[],c.errors),{table:a,errors:u}}return a[r]=xt,{table:a,errors:o}}),{table:u,errors:h})}function Gt(e,t){var r=Tt(e,t),n=Ft(t).filter((function(t){return void 0===e.symbol(t)})).map((function(e){return'"'.concat(e,'" is not defined')}));return n.length>0?r.addErrors(n):r}var Ut=jt(3),$t=bt;function Yt(e,t){var r=e.asts.funcs,n=V()(t).mapValues((function(e,t){switch(e.type){case Qe.Scalar:return ht(t);case Qe.Quaternion:return pt(t);case Qe.Vector:return vt(t,e.rows);case Qe.Matrix:return wt(t,e.rows,e.cols)}})).value(),o=Ct(Wt(r,V.a.defaults({dt:ht("dt")},n)).table),i=V()(e.asts.transition).mapValues((function(e,r){var n,i,a=Gt(o,e),s=a.typeCode,c=t[r];if(!c)return a.addErrors(['"'.concat(r,'" is not a status variable')]);if(tt(c))return tt(s)?a:a.addErrors(Et("scalar expected",s)).withTypeCode(xt);if(rt(c))return rt(s)?a:a.addErrors(Et("quaternion expected",s)).withTypeCode(bt);if(nt(c))return nt(s)&&s.rows===c.rows?a:a.addErrors(Et("vector".concat(c.rows," expected"),s)).withTypeCode(jt(c.rows));if(ot(c))return ot(s)&&s.rows===c.rows&&s.cols===c.cols?a:a.addErrors(Et("matrix".concat(c.rows,"x").concat(c.cols," expected"),s)).withTypeCode((n=c.rows,i=c.cols,ft(Oe(V.a.range(0,n).map((function(e){return V.a.range(0,i).map((function(e){return 0}))}))))));throw new Error("unexpected branch")})).value(),a={bodies:[],funcs:{},initialStatus:{},transition:V.a.mapValues(i,"errors")};return{code:V()(i).mapValues("typeCode").toPairs().filter((function(e){var r=Object(Ne.a)(e,2),n=r[0];r[1];return void 0!==t[n]})).fromPairs().value(),errors:a}}function Xt(e){(new Dt.Validator).validate(e,zt,{throwError:!0});var t=De.match(Nt),r=e.version.match(Nt);if(null===r||null===t||r[1]!==t[1]||parseInt(r[2])>parseInt(t[2]))throw new Error("version ".concat(e.version," is not compatible with supported version ").concat(De));return!0}function er(e){var t=function(e){var t=qt(e,ue);return{asts:qt(t,(function(e){return e.ast})),errors:qt(t,(function(e){return e.errors}))}}(e),r=function(e){var t=Wt(V.a.fromPairs(V.a.concat(V.a.toPairs(e.asts.funcs),V.a.toPairs(e.asts.initialStatus))),{dt:ut(0)}),r=t.table,n=t.errors,o={bodies:[],funcs:V()(e.asts.funcs).mapValues((function(e,t){var r;return null!==(r=n[t])&&void 0!==r?r:[]})).value(),initialStatus:V()(e.asts.initialStatus).mapValues((function(e,t){var r;return null!==(r=n[t])&&void 0!==r?r:[]})).value(),transition:{}};return{table:V()(e.asts.initialStatus).mapValues((function(e,t){return r[t]})).value(),errors:o}}(t),n=r.table,o=r.errors,i=function(e,t){var r=e.asts.funcs,n=V()(t).mapValues((function(e,t){switch(e.type){case Qe.Scalar:return ht(t);case Qe.Quaternion:return pt(t);case Qe.Vector:return vt(t,e.rows);case Qe.Matrix:return wt(t,e.rows,e.cols)}})).value(),o=Ct(Wt(r,V.a.defaults({dt:ut(0)},n)).table),i=Lt(e.asts.bodies,(function(e){var t=Gt(o,e),r=t.typeCode;return nt(r)&&3===r.rows?t:t.withTypeCode(Ut).addErrors(Et("vector3 expected",r))}),(function(e){var t=Gt(o,e);return rt(t.typeCode)?t:t.withTypeCode($t).addErrors(Et("quaternion expected",t.typeCode))}));return{code:Lt(i,(function(e){if(!nt(e.typeCode))throw new Error("Worng type");return e.typeCode}),(function(e){if(!rt(e.typeCode))throw new Error("Worng type");return e.typeCode})),errors:{bodies:Bt(i,(function(e){return e.errors})),funcs:{},initialStatus:{},transition:{}}}}(t,n),a=i.code,s=i.errors,c=Yt(t,n),u=c.code,d=c.errors,l=V.a.mapValues(n,"code"),f=Lt(a,(function(e){return e.code}),(function(e){return e.code})),h=V.a.mapValues(u,"code");return{rules:{bodies:function(e){var t=V.a.assign({dt:0},e);return Lt(f,(function(e){return e(t)}),(function(e){return e(t)}))},initialStatus:function(){var e={dt:0};return V.a.mapValues(l,(function(t){return t(e)}))},next:function(e,t){var r=V.a.assign({dt:t},e),n=V.a.mapValues(h,(function(e){return e(r)}));return V.a.defaults(n,e)}},errors:Kt(t.errors,Kt(o,Kt(s,d)))}}var tr="leibniz",rr={version:De,bodies:[],funcs:{},initialStatus:{},transition:{}},nr=function(e){Object(f.a)(r,e);var t=Object(h.a)(r);function r(e){var n;return Object(d.a)(this,r),(n=t.call(this,e)).leibniz=void 0,n.state={maxDt:"0.01",alertShow:!1,modalShown:!1,importModalShown:!1},n}return Object(l.a)(r,[{key:"processDefs",value:function(e,t){var r=null!==t&&void 0!==t?t:this.state.leibniz,n=er(e),o=n.rules,i=n.errors;localStorage.setItem(tr,JSON.stringify(e)),r&&(r.rules=o),this.setState({defs:e,rules:o,errors:i})}},{key:"onSceneMount",value:function(e){var t=new Be(e);t.init({cameraType:Ee.ArcRotate,maxDt:parseFloat(this.state.maxDt)}),this.setState({leibniz:t});var r=localStorage.getItem(tr),n=r?JSON.parse(r):rr;this.processDefs(n,t)}},{key:"onReset",value:function(){var e=this;this.showOptionPanel("Reset definitions ?","The definitions will be resetted to default value.","Reset",(function(){return e.reset()}))}},{key:"onLoad",value:function(e){var t=this;this.showOptionPanel("Load definitions "+e+" ?","The definitions will be load from "+e+" .","Load",(function(){return t.load(e)}))}},{key:"showOptionPanel",value:function(e,t,r,n){this.setState({optionShow:!0,optionTitle:e,optionMessage:t,optionConfirmBtn:r,optionConfirm:n})}},{key:"hideOptionPanel",value:function(){this.setState({optionShow:!1})}},{key:"showAlert",value:function(e,t){this.setState({alertShow:!0,alertTitle:e,alertMessage:t})}},{key:"hideAlert",value:function(){this.setState({alertShow:!1})}},{key:"reset",value:function(){this.processDefs(rr),this.hideOptionPanel()}},{key:"load",value:function(e){var t=this,r="/".concat(Ae.a,"/").concat(e);j.a.getJSON(r).pipe(Object(g.a)((function(e){return t.onLoaded(e)}),(function(e){return t.onLoadError(e)}))).subscribe()}},{key:"onLoaded",value:function(e){this.hideOptionPanel();try{Xt(e)&&this.processDefs(e)}catch(t){this.onError(t)}}},{key:"onLoadError",value:function(e){console.error(e);var t=e.xhr.status+" - "+e.xhr.statusText;console.error(t),this.showAlert("Error",t),this.hideOptionPanel()}},{key:"showImportPanel",value:function(){this.setState({importModalShown:!0})}},{key:"hideImportPanel",value:function(){this.setState({importModalShown:!1})}},{key:"importFile",value:function(e){try{this.hideAlert(),this.hideImportPanel();var t=JSON.parse(e);Xt(t)&&this.processDefs(t)}catch(r){console.error("Error parsing",e),this.onError(r)}}},{key:"onError",value:function(e){this.showAlert("Error","Error parsing file "+e),this.hideImportPanel()}},{key:"showExportPanel",value:function(){var e=this;this.showOptionPanel("Export definitions ?","The definitions will be exported into a local file.","Export",(function(){return e.exportFile()}))}},{key:"setMaxDt",value:function(e){if(this.setState({maxDt:e}),this.leibniz){var t=parseFloat(e);this.leibniz.maxDt=Math.max(.001,t)}}},{key:"exportFile",value:function(){var e=this.state.defs;if(this.hideOptionPanel(),e){var t=V.a.defaults({version:De},e),r=JSON.stringify(t,null,2),n=new Blob([r],{type:"text/plain;charset=utf-8"});Object(b.saveAs)(n,"test.json")}}},{key:"render",value:function(){var e=this,t=this.state,r=t.alertShow,n=t.alertTitle,o=t.alertMessage,a=t.importModalShown,s=t.optionShow,c=t.optionTitle,u=t.optionMessage,d=t.optionConfirmBtn,l=t.optionConfirm,f=t.maxDt,h=t.defs,b=t.errors,j=t.rules;return Object(i.jsxs)(p.a,{fluid:!0,children:[Object(i.jsx)(Ve,{onReset:function(){return e.onReset()},onLoad:function(t){return e.onLoad(t)},onImport:function(){return e.showImportPanel()},onExport:function(){return e.showExportPanel()}}),Object(i.jsx)(_e,{isVisible:r,title:n,message:o,onClose:function(){return e.hideAlert()}}),Object(i.jsx)(p.a,{children:Object(i.jsxs)(v.a,{id:"Tab",defaultActiveKey:"home",children:[Object(i.jsxs)(w.a,{eventKey:"home",title:"Home",children:[Object(i.jsx)(O,{onSceneMount:function(t){return e.onSceneMount(t)},canvasClass:"graphCanvas"}),Object(i.jsxs)(y.a,{inline:!0,children:[Object(i.jsxs)(m.a,{controlId:"formInlineName",children:[Object(i.jsx)(y.a.Label,{children:"Max dt"})," ",Object(i.jsx)(x.a,{type:"text",placeholder:"Max dt",onChange:function(t){return e.setMaxDt(t.target.value)},value:f})]})," "]})]}),Object(i.jsx)(w.a,{eventKey:"editor",title:"Editor",children:Object(i.jsx)(ve,{defs:h,errors:b,onChange:function(t){return e.processDefs(t)}})}),Object(i.jsx)(w.a,{eventKey:"dump",title:"Dump panel",children:Object(i.jsx)(Me,{rules:j})})]})}),Object(i.jsx)(we,{show:a,onCancel:function(){return e.hideImportPanel()},onFileRead:function(t){return e.importFile(t)},onError:function(t){return e.onError(t)}}),Object(i.jsx)(_,{show:!!s,title:c,message:u,confirmButton:d||"",onCancel:function(){return e.hideOptionPanel()},onConfirm:l})]})}}]),r}(a.Component),or=function(e){e&&e instanceof Function&&r.e(3).then(r.bind(null,129)).then((function(t){var r=t.getCLS,n=t.getFID,o=t.getFCP,i=t.getLCP,a=t.getTTFB;r(e),n(e),o(e),i(e),a(e)}))};u.a.render(Object(i.jsx)(s.a.StrictMode,{children:Object(i.jsx)(nr,{})}),document.getElementById("root")),or()},57:function(e){e.exports=JSON.parse('{"b":"1.3.1","a":"leibniz"}')},89:function(e,t,r){},90:function(e,t,r){}},[[105,1,2]]]);
//# sourceMappingURL=main.c9663606.chunk.js.map